<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login</title>
  </head>
  <body>
    <script>
      const GOOGLE_CLIENT_ID = '358891470255-7h1kggp8d1io8947nll6kq51815nbpgp.apps.googleusercontent.com';
      const WEB_STATE_KEY = 'recordsaas_oauth_state';
      const DESKTOP_STATE_KEY = 'recordsaas_desktop_oauth_state';
      const DESKTOP_CONTEXT_KEY = 'recordsaas_desktop_oauth_context';
      const DESKTOP_PENDING_KEY = 'recordsaas_desktop_login_pending';
      const DESKTOP_CONTEXT_MAX_AGE_MS = 15 * 60 * 1000;

      const searchParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.slice(1));

      function safeApiBase(raw) {
        const fallback = window.location.origin.replace(/\/$/, '');

        if (!raw) {
          return fallback;
        }

        try {
          const parsed = new URL(raw);
          if (parsed.protocol !== 'http:' && parsed.protocol !== 'https:') {
            return fallback;
          }
          return `${parsed.origin}${parsed.pathname}`.replace(/\/$/, '');
        } catch (_) {
          return fallback;
        }
      }

      function sanitizeDesktopRedirectUri(raw) {
        const fallback = 'recordsaas://auth/callback';

        if (!raw) {
          return fallback;
        }

        try {
          const parsed = new URL(raw);
          if (parsed.protocol === 'recordsaas:' && parsed.hostname === 'auth' && parsed.pathname === '/callback') {
            return parsed.toString();
          }
        } catch (_) {
          // ignore invalid URL and fallback
        }

        return fallback;
      }

      function loadDesktopContext() {
        const raw = localStorage.getItem(DESKTOP_CONTEXT_KEY);
        if (!raw) {
          return null;
        }

        try {
          const parsed = JSON.parse(raw);
          if (!parsed || typeof parsed !== 'object') {
            localStorage.removeItem(DESKTOP_CONTEXT_KEY);
            return null;
          }

          const createdAt = typeof parsed.createdAt === 'number' ? parsed.createdAt : 0;
          if (!createdAt || Date.now() - createdAt > DESKTOP_CONTEXT_MAX_AGE_MS) {
            localStorage.removeItem(DESKTOP_CONTEXT_KEY);
            localStorage.removeItem(DESKTOP_PENDING_KEY);
            return null;
          }

          return {
            nonce: typeof parsed.nonce === 'string' ? parsed.nonce : '',
            apiBase: safeApiBase(typeof parsed.apiBase === 'string' ? parsed.apiBase : ''),
            redirectUri: sanitizeDesktopRedirectUri(typeof parsed.redirectUri === 'string' ? parsed.redirectUri : ''),
            createdAt,
          };
        } catch (_) {
          localStorage.removeItem(DESKTOP_CONTEXT_KEY);
          localStorage.removeItem(DESKTOP_PENDING_KEY);
          return null;
        }
      }

      function saveDesktopContext(context) {
        localStorage.setItem(DESKTOP_CONTEXT_KEY, JSON.stringify(context));
      }

      function clearDesktopContext() {
        localStorage.removeItem(DESKTOP_CONTEXT_KEY);
      }

      function markDesktopPending() {
        localStorage.setItem(DESKTOP_PENDING_KEY, '1');
      }

      function clearDesktopPending() {
        localStorage.removeItem(DESKTOP_PENDING_KEY);
      }

      const desktopRequested = searchParams.get('desktop') === '1';
      let desktopContext = loadDesktopContext();

      if (desktopRequested) {
        desktopContext = {
          nonce: searchParams.get('nonce') || '',
          apiBase: safeApiBase(searchParams.get('api_base')),
          redirectUri: sanitizeDesktopRedirectUri(searchParams.get('redirect_uri')),
          createdAt: Date.now(),
        };
        saveDesktopContext(desktopContext);
        markDesktopPending();
      }

      const isGoogleCallback = Boolean(hashParams.get('id_token') || hashParams.get('error'));
      const desktopMode = desktopRequested || Boolean(desktopContext && isGoogleCallback);
      const apiBase = desktopMode
        ? safeApiBase((desktopContext && desktopContext.apiBase) || searchParams.get('api_base'))
        : safeApiBase(searchParams.get('api_base'));

      function generateToken() {
        if (window.crypto && window.crypto.getRandomValues) {
          const bytes = new Uint8Array(16);
          window.crypto.getRandomValues(bytes);
          return Array.from(bytes).map((b) => b.toString(16).padStart(2, '0')).join('');
        }

        return Math.random().toString(36).slice(2) + Date.now().toString(36);
      }

      function safeDesktopRedirectUri() {
        const redirectRaw = desktopContext && desktopContext.redirectUri
          ? desktopContext.redirectUri
          : searchParams.get('redirect_uri');

        return new URL(sanitizeDesktopRedirectUri(redirectRaw));
      }

      function redirectToDesktopApp(params) {
        const redirectUri = safeDesktopRedirectUri();
        clearDesktopContext();
        clearDesktopPending();
        localStorage.removeItem(DESKTOP_STATE_KEY);

        Object.entries(params).forEach(([key, value]) => {
          if (value) redirectUri.searchParams.set(key, String(value));
        });

        window.location.replace(redirectUri.toString());
      }

      function redirectToLanding(errorCode) {
        if (errorCode) {
          localStorage.setItem('recordsaas_login_error', errorCode);
        }
        window.location.replace('/');
      }

      async function tryDesktopSessionBridge() {
        if (!desktopContext) {
          return false;
        }

        const sessionToken = localStorage.getItem('recordsaas_session');
        if (!sessionToken) {
          return false;
        }

        try {
          const res = await fetch(`${apiBase}/api/auth/desktop/session`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: `Bearer ${sessionToken}`,
            },
            body: JSON.stringify({
              nonce: desktopContext.nonce || undefined,
            }),
          });

          if (!res.ok) {
            if (res.status === 401) {
              localStorage.removeItem('recordsaas_session');
              localStorage.removeItem('recordsaas_user');
            }
            return false;
          }

          const data = await res.json();
          if (!data || typeof data.desktopCode !== 'string' || data.desktopCode.length === 0) {
            return false;
          }

          redirectToDesktopApp({ code: data.desktopCode });
          return true;
        } catch (_) {
          return false;
        }
      }

      function startDesktopGoogleLogin() {
        const state = generateToken();
        const nonce = generateToken();
        localStorage.setItem(DESKTOP_STATE_KEY, state);

        const callbackUri = `${window.location.origin}${window.location.pathname}`;

        const url = new URL('https://accounts.google.com/o/oauth2/v2/auth');
        url.searchParams.set('client_id', GOOGLE_CLIENT_ID);
        url.searchParams.set('redirect_uri', callbackUri);
        url.searchParams.set('response_type', 'id_token');
        url.searchParams.set('scope', 'openid email profile');
        url.searchParams.set('response_mode', 'fragment');
        url.searchParams.set('prompt', 'select_account');
        url.searchParams.set('nonce', nonce);
        url.searchParams.set('state', state);

        window.location.assign(url.toString());
      }

      async function completeWebFlow(idToken, state) {
        const expectedState = localStorage.getItem(WEB_STATE_KEY);
        if (expectedState) localStorage.removeItem(WEB_STATE_KEY);

        if (expectedState && expectedState !== state) {
          redirectToLanding('invalid_state');
          return;
        }

        try {
          const res = await fetch(`${apiBase}/api/auth/google`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idToken }),
          });

          if (!res.ok) {
            throw new Error('Login failed');
          }

          const data = await res.json();
          localStorage.setItem('recordsaas_session', data.sessionToken);
          localStorage.setItem('recordsaas_user', JSON.stringify(data.user));
          window.location.replace('/');
        } catch (_) {
          redirectToLanding('login_failed');
        }
      }

      async function completeDesktopFlow(idToken, state) {
        const expectedState = localStorage.getItem(DESKTOP_STATE_KEY);
        if (expectedState) localStorage.removeItem(DESKTOP_STATE_KEY);

        if (expectedState && expectedState !== state) {
          redirectToDesktopApp({ error: 'invalid_state' });
          return;
        }

        try {
          const res = await fetch(`${apiBase}/api/auth/google`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              idToken,
              flow: 'desktop',
              nonce: (desktopContext && desktopContext.nonce) || undefined,
            }),
          });

          if (!res.ok) {
            throw new Error('Desktop login failed');
          }

          const data = await res.json();
          if (!data.desktopCode) {
            throw new Error('Desktop code missing');
          }

          redirectToDesktopApp({ code: data.desktopCode });
        } catch (_) {
          redirectToDesktopApp({ error: 'desktop_login_failed' });
        }
      }

      async function bootstrap() {
        const error = hashParams.get('error');
        const idToken = hashParams.get('id_token');
        const state = hashParams.get('state');

        if (!idToken && !error) {
          if (desktopMode) {
            const bridged = await tryDesktopSessionBridge();
            if (bridged) {
              return;
            }

            if (searchParams.get('start') === '1') {
              startDesktopGoogleLogin();
              return;
            }

            markDesktopPending();
            redirectToLanding();
            return;
          }

          redirectToLanding();
          return;
        }

        if (error || !idToken || !state) {
          if (desktopMode) {
            redirectToDesktopApp({ error: error || 'invalid_callback' });
          } else {
            redirectToLanding(error || 'invalid_callback');
          }
          return;
        }

        if (desktopMode) {
          await completeDesktopFlow(idToken, state);
          return;
        }

        await completeWebFlow(idToken, state);
      }

      void bootstrap();
    </script>
  </body>
</html>
